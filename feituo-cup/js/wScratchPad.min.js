/*
       Copyright (c) 2012 Websanova.
 @license         This wScratchPad jQuery plug-in is dual licensed under the MIT and GPL licenses.
 @link            http://www.websanova.com
 @github			http://github.com/websanova/wScratchPad
 @version         Version 1.4.4

*/
var oWidth,oHeight;
(function(d){function f(b,a){this.sp=null;this.settings=b;this.$elem=a;this.enabled=!0;this.scratch=!1;this.ctx=this.canvas=null;return this}d.fn.wScratchPad=function(b,a){if("object"===typeof b)a=b;else if("string"==typeof b){var c=[],g=this.each(function(){var e=d(this).data("_wScratchPad");e&&("reset"===b?e.reset():"clear"===b?e.clear():"enabled"===b?e.enabled=!0===a:void 0!==d.fn.wScratchPad.defaultSettings[b]&&(void 0!==a?e.settings[b]=a:c.push(e.settings[b])))});return 1===c.length?c[0]:0<c.length?
c:g}a=d.extend({},d.fn.wScratchPad.defaultSettings,a||{});return this.each(function(){var b=d(this),c=jQuery.extend(!0,{},a);if(!document.createElement("canvas").getContext)return b.html("Browser does not support HTML5 canvas, please upgrade to a more modern browser."),!1;c=new f(c,b);b.append(c.generate());c.pixels=c.canvas.width*c.canvas.height;b.data("_wScratchPad",c);c.init()})};d.fn.wScratchPad.defaultSettings={width:null,height:null,image:null,image2:null,color:null,overlay:"none",size:null,
realtimePercent:!0,scratchDown:null,scratchUp:null,scratchMove:null,cursor:null};f.prototype={generate:function(){var b=this;this.canvas=document.createElement("canvas");this.ctx=this.canvas.getContext("2d");this.sp=d("<div></div>").css({position:"relative"}).append(d(this.canvas).attr("width",this.settings.width+"px").attr("height",this.settings.height+"px"));d(this.canvas).mousedown(function(a){if(!b.enabled)return!0;a.preventDefault();a.stopPropagation();b.canvas_offset=d(b.canvas).offset();b.scratch=
!0;b.scratchFunc(a,b,"Down")}).mousemove(function(a){a.preventDefault();a.stopPropagation();b.scratch&&b.scratchFunc(a,b,"Move")}).mouseup(function(a){a.preventDefault();a.stopPropagation();b.scratch&&(b.scratch=!1,b.scratchFunc(a,b,"Up"))});this.bindMobile(this.sp);return this.sp},bindMobile:function(b){b.bind("touchstart touchmove touchend touchcancel",function(){var a=event.changedTouches[0],b="";switch(event.type){case "touchstart":b="mousedown";break;case "touchmove":b="mousemove";break;case "touchend":b=
"mouseup";break;default:return}var d=document.createEvent("MouseEvent");d.initMouseEvent(b,!0,!0,window,1,a.screenX,a.screenY,a.clientX,a.clientY,!1,!1,!1,!1,0,null);a.target.dispatchEvent(d);event.preventDefault()})},init:function(){this.sp.css("width",this.settings.width);this.sp.css("height",this.settings.height);this.sp.css({backgroundSize:"100% 100%"});this.sp.css("cursor",this.settings.cursor?'url("'+this.settings.cursor+'"), default':"default");d(this.canvas).css({cursor:this.settings.cursor?
'url("'+this.settings.cursor+'"), default':"default"});this.canvas.width=this.settings.width;this.canvas.height=this.settings.height;this.pixels=this.canvas.width*this.canvas.height;this.settings.image2?this.drawImage(this.settings.image2):("none"!=this.settings.overlay?(this.settings.image&&this.drawImage(this.settings.image),this.ctx.globalCompositeOperation=this.settings.overlay):this.setBgImage(),this.ctx.fillStyle=this.settings.color,this.ctx.beginPath(),this.ctx.rect(0,0,this.settings.width,
this.settings.height),this.ctx.fill())},reset:function(){this.ctx.globalCompositeOperation="source-over";this.init()},clear:function(){this.ctx.clearRect(0,0,this.settings.width,this.settings.height)},setBgImage:function(){this.settings.image&&(this.sp.css({backgroundImage:"url("+this.settings.image+")"}),this.sp.css({backgroundSize:"100% 100%"}))},drawImage:function(b){var a=this,c=new Image;c.src=b;d(c).load(function(){a.ctx.drawImage(c,0,0,oWidth,oHeight);a.setBgImage()})},scratchFunc:function(b,
a,c){b.pageX=Math.floor(b.pageX-a.canvas_offset.left);b.pageY=Math.floor(b.pageY-a.canvas_offset.top);a["scratch"+c](b,a);(this.settings.realtimePercent||"Up"==c)&&a.settings["scratch"+c]&&a.settings["scratch"+c].apply(a,[b,a.scratchPercentage(a)])},scratchPercentage:function(b){for(var a=0,c=b.ctx.getImageData(0,0,b.canvas.width,b.canvas.height),d=0,e=c.data.length;d<e;d+=4)0==c.data[d]&&0==c.data[d+1]&&0==c.data[d+2]&&0==c.data[d+3]&&a++;return a/b.pixels*100},scratchDown:function(b,a){a.ctx.globalCompositeOperation=
"destination-out";a.ctx.lineJoin="round";a.ctx.lineCap="round";a.ctx.strokeStyle=a.settings.color;a.ctx.lineWidth=a.settings.size;a.ctx.beginPath();a.ctx.arc(b.pageX,b.pageY,a.settings.size/2,0,2*Math.PI,!0);a.ctx.closePath();a.ctx.fill();a.ctx.beginPath();a.ctx.moveTo(b.pageX,b.pageY)},scratchMove:function(b,a){a.ctx.lineTo(b.pageX,b.pageY);a.ctx.stroke()},scratchUp:function(b,a){a.ctx.closePath()}}})(jQuery);